# 执行计划 - Testing & TDD

本文档详细描述了为本项目引入测试体系并采用 TDD 开发方法的执行计划，目标读者为后续接手该项目的 LLM 或开发者。

---

## 1. 目标

- **建立全面的测试体系**：覆盖单元测试、集成测试和端到端（E2E）测试，确保项目的前后端组件均能得到充分的测试验证。
- **采用 TDD（测试驱动开发）流程**：从编写测试用例开始，让开发过程始终由测试反馈驱动，提升代码质量和降低回归风险。

---

## 2. 测试工具选择

- **Vitest**：作为主要测试运行器，具备快速执行、原生 ESM 支持以及与 Vite 良好的集成。（可替换 Jest 来加快反馈速度）
- **React Testing Library**：针对 React 组件的交互式测试框架，模拟用户行为、检查 UI 状态。
- **MSW (Mock Service Worker)**：用于在集成测试中模拟 API 请求，确保外部 API 不干扰本地测试。（用于模拟 fetch 调用、Next.js 服务端 Action 以及缓存方法）
- **Playwright**：实现端到端测试，验证用户从 UI 到后端交互的完整流程。

---

## 3. 执行步骤

### 3.1 设置测试环境

1. **安装必要依赖**
   - 安装 Vitest、React Testing Library 及相关依赖
   - 安装 MSW
   - 安装 Playwright

2. **配置 Vitest**
   - 创建或更新 `vitest.config.ts`，设置需要测试的文件、全局环境、TypeScript 兼容性，并确保加载全局 setup 文件（例如 `tests/setupTests.ts`）。

3. **文件和目录结构规划**
   - 在项目根目录建立 `/tests` 目录，内部分别建立：
     - `/tests/unit` 用于单元测试
     - `/tests/integration` 用于集成测试
     - `/tests/e2e` 用于端到端测试

4. **配置 MSW**
   - 在 `/tests` 目录下建立 `setupTests.ts` 用于启动 MSW 并拦截 API 请求。
   - 并在 Vitest 配置中引入 `setupTests.ts`。

✅ [已完成]

---

### 3.2 编写单元测试

- **测试内容**
  - 针对独立 React 组件（例如 `app/counter-button.tsx`）编写单元测试，验证组件在不同状态下的展示（例如 pending 状态下应显示 `animate-pulse`）。

- **TDD 流程**
  1. 编写失败的测试用例（红灯阶段）
  2. 实现或修改代码使测试通过（绿灯阶段）
  3. 重构代码保持测试通过（重构阶段）

✅ [已完成]

---

### 3.3 编写集成测试

- **测试内容**
  - 针对包含 API 调用的服务端组件（例如 `app/counter.tsx`），编写集成测试，验证 API 数据解析、组件渲染、缓存失效及重新请求功能，以及与 Next.js 服务端 Action 的交互。

✅ [已完成]

---

### 3.4 编写端到端（E2E）测试

- **测试内容**
  - 使用 Playwright 实现端到端测试，覆盖页面加载、用户交互、数据更新、加载状态及数据持久化等关键流程。

✅ [已完成]

---

### 3.5 持续集成（CI/CD 集成）

- **配置 CI**
  - 使用 GitHub Actions 自动运行单元、集成及端到端测试，并在测试通过后自动部署到 Vercel。
  - 配置测试覆盖率和测试结果报告的上传。

✅ [已完成]

---

## 4. TDD 开发流程步骤

1. **编写测试用例**
   - 根据业务需求或问题场景，先编写测试，确保测试会失败（红灯阶段）。

2. **实现业务逻辑**
   - 根据测试结果编写代码使测试通过（绿灯阶段）。

3. **重构与优化**
   - 在所有测试通过后，对代码进行重构和优化（重构阶段）。

4. **提交与回顾**
   - 提交前确保所有测试通过，并定期回顾测试覆盖与质量。

✅ [已完成]

---

## 5. 里程碑与时间规划

- **第 1 阶段：设置测试环境**（1-2 天） ✅
- **第 2 阶段：单元测试和集成测试覆盖关键组件**（3-5 天） ✅
- **第 3 阶段：端到端测试集成**（2-3 天） ✅
- **第 4 阶段：CI/CD 集成**（1-2 天） ✅
- **第 5 阶段：持续改进与 TDD 流程落地**（持续进行） ☐

---

## 6. 最终目标

- **高覆盖率测试**：确保所有主要功能点及边界情况均有充分的测试支持。
- **快速反馈机制**：利用 Vitest 和 Playwright 实现快速、实时的测试反馈，支持高效开发。
- **持续集成**：将测试集成到 CI/CD 流程中，确保每次代码变更都能及时进行回归测试，降低风险。

✅ [已完成]

---

## 7. 附录

- **参考文档**  
  - [Vitest 官方文档](https://vitest.dev/)  
  - [React Testing Library 官方文档](https://testing-library.com/docs/react-testing-library/intro/)  
  - [MSW 官方文档](https://mswjs.io/)  
  - [Playwright 官方文档](https://playwright.dev/)  
  - [TDD 开发流程介绍](https://agiledata.org/essays/tdd.html) 